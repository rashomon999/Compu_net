<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat COMPU_NET - ICE + WebSocket</title>
  
  <!-- ‚úÖ Ice.js DEBE cargarse ANTES que bundle.js -->
  <script>
    window._iceLoadPromise = new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ice/3.7.100/Ice.min.js';
      script.onload = () => {
        console.log('‚úÖ Ice.js cargado desde CDN');
        if (typeof Ice !== 'undefined') {
          window.Ice = Ice;
          resolve(Ice);
        } else {
          reject(new Error('Ice.js se carg√≥ pero no est√° disponible'));
        }
      };
      script.onerror = () => {
        reject(new Error('No se pudo cargar Ice.js desde CDN'));
      };
      document.head.appendChild(script);
    });
  </script>

  <style>
    /* Estilos para la configuraci√≥n del servidor */
    .server-config {
      margin-top: 20px;
      border-top: 1px solid #e0e0e0;
      padding-top: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-header h3 {
      margin: 0;
      font-size: 14px;
      color: #333;
    }

    .btn-toggle {
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-toggle:hover {
      background: #e0e0e0;
    }

    .config-panel {
      margin-top: 15px;
      animation: slideDown 0.3s ease;
    }

    .config-panel.hidden {
      display: none;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      color: #555;
    }

    .help-icon {
      cursor: help;
      font-size: 14px;
      opacity: 0.7;
    }

    .server-hint {
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      font-size: 12px;
    }

    .server-hint p {
      margin: 0 0 8px 0;
      color: #333;
    }

    .server-hint ul {
      margin: 8px 0 0 20px;
      padding: 0;
      color: #666;
    }

    .server-hint li {
      margin-bottom: 4px;
    }

    .server-hint .warning {
      margin-top: 10px;
      color: #ff6b6b;
      font-weight: 500;
    }

    .btn-secondary {
      width: 100%;
      padding: 10px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 8px;
      font-size: 13px;
    }

    .connection-status.hidden {
      display: none;
    }

    .connection-status.connecting {
      background: #fff3cd;
      color: #856404;
    }

    .connection-status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .connection-status.success {
      background: #d4edda;
      color: #155724;
    }

    .status-icon {
      font-size: 16px;
    }

    .status-icon.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <!-- PANTALLA DE LOGIN CON CONFIGURACI√ìN DE SERVIDOR -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h1>üåê Chat COMPU_NET</h1>
      <p class="subtitle">Sistema de mensajer√≠a con ZeroC Ice</p>
      
      <div class="section">
        <label for="usernameInput">Nombre de usuario</label>
        <input 
          type="text" 
          id="usernameInput" 
          placeholder="Tu nombre de usuario"
          autocomplete="off"
        >
      </div>
      
      <!-- ‚úÖ CONFIGURACI√ìN DEL SERVIDOR -->
      <div class="section server-config">
        <div class="section-header">
          <h3>‚öôÔ∏è Configuraci√≥n del Servidor</h3>
          <button type="button" id="toggleServerConfig" class="btn-toggle">
            Mostrar opciones
          </button>
        </div>
        
        <div id="serverConfigPanel" class="config-panel hidden">
          <div class="input-group">
            <label for="serverHostInput">
              Direcci√≥n del servidor
              <span class="help-icon" title="Usa 'localhost' para servidor local o la IP para red local (ej: 192.168.1.100)">‚ÑπÔ∏è</span>
            </label>
            <input 
              type="text" 
              id="serverHostInput" 
              placeholder="localhost o IP del servidor"
              value="localhost"
            >
          </div>
          
          <div class="input-group">
            <label for="serverPortInput">Puerto</label>
            <input 
              type="number" 
              id="serverPortInput" 
              placeholder="10000"
              value="10000"
              min="1"
              max="65535"
            >
          </div>
          
          <div class="server-hint">
            <p><strong>üí° Conexi√≥n en red local:</strong></p>
            <ul>
              <li><strong>Mismo equipo:</strong> localhost:10000</li>
              <li><strong>Otra computadora:</strong> IP-del-servidor:10000</li>
              <li>Ejemplo: 192.168.1.100:10000</li>
            </ul>
            <p class="warning">‚ö†Ô∏è Aseg√∫rate que el firewall permita conexiones al puerto 10000</p>
          </div>
          
          <button type="button" id="detectServerBtn" class="btn-secondary">
            üîç Detectar servidor autom√°ticamente
          </button>
        </div>
      </div>
      
      <button id="loginButton" class="btn-primary">Conectar</button>
      
      <div id="connectionStatus" class="connection-status hidden">
        <span class="status-icon">üîÑ</span>
        <span class="status-text">Conectando...</span>
      </div>
      
      <div class="tech-info">
        <small>üîó WebSocket ICE | üé§ Notas de voz | üìû Llamadas | ‚ö° Tiempo real</small>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE CHAT -->
  <div id="chatContainer" class="chat-container hidden">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="user-info">
        <div class="user-avatar">üë§</div>
        <strong id="currentUsername"></strong>
        <button id="logoutButton" class="logout-btn">Salir</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="chats">üí¨ Chats</button>
        <button class="tab" data-tab="grupos">üë• Grupos</button>
      </div>

      <!-- TAB: CHATS -->
      <div id="chatsTab" class="tab-content active">
        <div class="section">
          <h3>Nuevo chat</h3>
          <div class="input-group">
            <input type="text" id="newChatUser" placeholder="Nombre de usuario">
            <button id="openChatButton">Abrir</button>
          </div>
        </div>
        
        <p class="section-title">Conversaciones</p>
        <div id="chatsList" class="conversations">
          <p class="empty-state">No hay conversaciones</p>
        </div>
      </div>

      <!-- TAB: GRUPOS -->
      <div id="gruposTab" class="tab-content">
        <div class="section">
          <h3>Crear grupo</h3>
          <div class="input-group">
            <input type="text" id="newGroupName" placeholder="Nombre del grupo">
            <button id="createGroupButton">Crear</button>
          </div>
        </div>

        <div class="section">
          <h3>Unirse a grupo</h3>
          <div class="input-group">
            <input type="text" id="joinGroupName" placeholder="Nombre del grupo">
            <button id="joinGroupButton">Unirse</button>
          </div>
        </div>

        <p class="section-title">Mis grupos</p>
        <div id="groupsList" class="conversations">
          <p class="empty-state">No est√°s en ning√∫n grupo</p>
        </div>
      </div>
    </div>

    <!-- √ÅREA PRINCIPAL -->
    <div class="main-content">
      <div id="chatHeader" class="chat-header">
        <div class="chat-info">
          <h2>Bienvenido üëã</h2>
          <p>Selecciona un chat o crea uno nuevo</p>
        </div>
      </div>

      <div id="messagesContainer" class="messages-container">
        <div class="welcome-message">
          <h3>üéâ Comienza a chatear</h3>
          <p>Selecciona una conversaci√≥n del sidebar o inicia una nueva</p>
          <ul>
            <li>üí¨ Mensajes de texto en tiempo real</li>
            <li>üé§ Notas de voz (hasta 30 segundos)</li>
            <li>üìû Llamadas de audio y video</li>
            <li>üë• Grupos de chat</li>
            <li>üîî Notificaciones push autom√°ticas</li>
          </ul>
        </div>
      </div>

      <!-- CONTROLES DE AUDIO -->
      <div id="audioControls" class="audio-controls hidden">
        <div id="voiceNoteControls" class="voice-controls">
          <button id="recordButton" class="btn-audio">
            üé§ Grabar nota de voz
          </button>
          <span id="recordingTimer" class="timer hidden">0:00</span>
          <button id="cancelButton" class="btn-secondary btn-small hidden">
            Cancelar
          </button>
        </div>
      </div>

      <!-- ENTRADA DE MENSAJES -->
      <div id="messageInputContainer" class="message-input hidden">
        <div class="input-wrapper">
          <textarea 
            id="messageText" 
            placeholder="Escribe un mensaje..."
            rows="2"
          ></textarea>
          <div class="action-buttons">
            <button id="sendMessageButton" class="btn-send">Enviar</button>
            <button id="toggleAudioButton" class="btn-audio-menu" title="Nota de voz">
              üé§
            </button>
            <button id="callButton" class="btn-call-menu" title="Iniciar llamada">
              üìû
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Script para manejar el toggle del panel de configuraci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('toggleServerConfig');
      const configPanel = document.getElementById('serverConfigPanel');
      
      if (toggleBtn && configPanel) {
        toggleBtn.addEventListener('click', () => {
          const isHidden = configPanel.classList.contains('hidden');
          configPanel.classList.toggle('hidden');
          toggleBtn.textContent = isHidden ? 'Ocultar opciones' : 'Mostrar opciones';
        });
      }
      
      // Cargar configuraci√≥n guardada
      const savedHost = localStorage.getItem('serverHost');
      const savedPort = localStorage.getItem('serverPort');
      
      if (savedHost) {
        document.getElementById('serverHostInput').value = savedHost;
      }
      if (savedPort) {
        document.getElementById('serverPortInput').value = savedPort;
      }
    });
  </script>

  <script src="/bundle.js"></script>
</body>
</html>